<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="A guide for installing and configuring Blockbridge storage for Kubernetes.">
<meta name="keywords" content=" kubernetes containers K8s">
<title>KUBERNETES CSI STORAGE GUIDE | Blockbridge Knowledgebase</title>
<!-- Google Fonts -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto&display=swap">

<link rel="stylesheet" href="/css/syntax.css">
<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

<!-- Latest compiled and minified CSS -->

<link rel="stylesheet" href="/css/bootstrap.min.css">
<link rel="stylesheet" href="/css/customstyles.css">
<link rel="stylesheet" href="/css/navbar.css">
<link rel="stylesheet" href="/css/sidebar.css">
<!-- most color styles are extracted out to here -->
<link rel="stylesheet" href="/css/theme-blockbridge.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="/js/jquery.navgoco.min.js"></script>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="/js/toc.js"></script>
<script src="/js/customscripts.js"></script>

<link rel="shortcut icon" href="/images/bb-favicon.ico" type="image/png">

<script>var clicky_site_ids = clicky_site_ids || []; clicky_site_ids.push(101238799);</script>
<script async src="//static.getclicky.com/js"></script>

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

    <script>
        $(document).ready(function() {
          // Initialize navgoco with default options
          $("#mysidebar").navgoco({
            caretHtml: '',
            accordion: false,
            openClass: 'active', // open
            save: false, // leave false or nav highlighting doesn't work right
            cookie: {
              name: 'navgoco',
              expires: false,
              path: '/'
            },
            slide: {
              duration: 400,
              easing: 'swing'
            }
          });

          $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>
  <!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid topnavlinks">
        <div class="navbar-header">
            <div class="navbar-brand"><svg class="bb-logo" width="100%" xmlns="http://www.w3.org/2000/svg" version="1.1" id="Layer_1" x="0px" y="0px" viewBox="0 0 346 40" enable-background="new 0 0 346 40" space="preserve">
  <path fill="#FFFFFF" d="M85.328613,31.876953L90.526855,0.72998h12.858887c2.340332,0,4.255859,0.209961,5.745117,0.62793 c1.489746,0.418457,2.739746,1.274414,3.750977,2.566895c1.010742,1.293457,1.515625,2.806641,1.515625,4.541016 c0,1.902344-0.600098,3.518066-1.800781,4.848633c-1.201172,1.331543-2.8125,2.225098-4.833496,2.681152 c3.419922,1.20166,5.129883,3.461426,5.129883,6.777832c0,2.416992-0.817383,4.540039-2.451172,6.365234 s-4.350586,2.738281-8.150391,2.738281H85.328613z M95.493652,24.986328h4.652832c1.444336,0,2.440918-0.304688,2.987793-0.913086 c0.547363-0.608398,0.821777-1.269531,0.821777-1.985352c0-0.881836-0.300781-1.59375-0.902344-2.132812 c-0.601074-0.540039-1.495117-0.810547-2.681641-0.810547h-3.90332L95.493652,24.986328z M97.557129,12.618652h3.563477 c2.847656,0,4.271484-0.943359,4.271484-2.82959c0-1.657715-1.127441-2.487305-3.382324-2.487305h-3.564941L97.557129,12.618652z"/>
  <path fill="#FFFFFF" d="M129.130859,0.72998l-5.196777,31.146973h-8.76123l5.19873-31.146973H129.130859z"/>
  <path fill="#FFFFFF" d="M140.753906,32.561523c-3.20752,0-5.901367-0.954102-8.08252-2.864258 c-2.181152-1.908203-3.271484-4.513672-3.271484-7.814453c0-3.970703,1.265137-7.23291,3.79541-9.788574 c2.530762-2.555664,5.726562-3.833496,9.587402-3.833496c3.526367,0,6.32666,1,8.401367,3 c2.075195,2.000977,3.112305,4.469238,3.112305,7.405273c0,4.365234-1.333984,7.772461-4.000977,10.22168 C147.627441,31.336914,144.447266,32.561523,140.753906,32.561523z M141.118652,26.948242 c1.595703,0,2.678711-1.186523,3.248535-3.55957c0.570312-2.373047,0.855469-4.357422,0.855469-5.956055 c0-2.433105-0.882324-3.650879-2.64502-3.650879c-1.56543,0-2.648438,1.213867-3.249023,3.640137 c-0.600586,2.426758-0.900879,4.408203-0.900879,5.943359C138.427734,25.754883,139.324707,26.948242,141.118652,26.948242z"/>
  <path fill="#FFFFFF" d="M171.578125,22.932617l6.953125,1.710938c-1.246094,2.981445-2.880859,5.046875-4.900879,6.195312 c-2.021973,1.147461-4.111816,1.722656-6.27002,1.722656c-3.176758,0-5.771973-1.008789-7.786133-3.026367 c-2.013672-2.017578-3.020508-4.610352-3.020508-7.776367c0-3.608398,1.188965-6.79834,3.567871-9.570312 c2.378906-2.77002,5.528809-4.156738,9.450195-4.156738c2.842285,0,5.251465,0.855957,7.227051,2.567871 c1.975586,1.710938,2.963867,3.912598,2.963867,6.605469l-7.819824,0.913086c0-2.494629-0.843262-3.742188-2.530273-3.742188 c-1.444336,0-2.470215,1.021484-3.078125,3.063477s-0.912109,3.825195-0.912109,5.349609 c0,2.255859,0.851074,3.383789,2.553711,3.383789C169.647949,26.172852,170.848633,25.092773,171.578125,22.932617z"/>
  <path fill="#FFFFFF" d="M208.717773,8.836426l-4.012695,3.602051c-2.220703,1.990234-3.77832,3.441895-4.675781,4.353516 l5.541992,15.084961h-8.745117l-3.182617-9.854492l-3.962891,3.580078l-1.051758,6.274414h-8.113281l5.198242-31.146973h8.134766 l-2.888672,17.239746l1.666016-1.666016c0.500977-0.533203,0.926758-0.958984,1.275391-1.279297l6.775391-6.187988H208.717773z"/>
  <path fill="#FFFFFF" d="M221.697266,0.72998l-1.841797,10.977539c1.200195-1.430664,2.269531-2.374023,3.210938-2.830078 c0.941406-0.456543,1.998047-0.685547,3.167969-0.685547c2.216797,0,3.993164,0.787109,5.330078,2.361816 c1.335938,1.574219,2.004883,3.898438,2.004883,6.970703c0,3.773438-1.056641,7.195312-3.168945,10.268555 c-2.112305,3.072266-5.043945,4.608398-8.796875,4.608398c-3.555664,0-6.032227-1.459961-7.429688-4.380859l-2.579102,3.856445 h-3.994141l5.199219-31.146973H221.697266z M217.824219,23.800781c0,0.851562,0.060547,1.4375,0.182617,1.756836 c0.12207,0.318359,0.387695,0.623047,0.796875,0.912109s0.917969,0.432617,1.524414,0.432617 c0.774414,0,1.438477-0.253906,1.992188-0.764648c0.554688-0.508789,1.085938-1.638672,1.59375-3.387695 c0.508789-1.75,0.763672-3.613281,0.763672-5.59082c0-2.296387-0.802734-3.445312-2.40918-3.445312 c-1.545898,0-2.65918,1.172852-3.34082,3.517578L217.824219,23.800781z"/>
  <path fill="#FFFFFF" d="M238.8125,8.831055h7.674805l-0.919922,5.55957c1.598633-4.163574,4.042969-6.244141,7.333008-6.244141 c0.258789,0,0.616211,0.037598,1.073242,0.114258l-1.025391,8.214844c-0.791016-0.046875-1.31543-0.069336-1.574219-0.069336 c-1.900391,0-3.294922,0.445312-4.18457,1.333984s-1.523438,2.463867-1.901367,4.726562l-1.567383,9.410156h-8.761719 L238.8125,8.831055z"/>
  <path fill="#FFFFFF" d="M266.025391,8.831055l-3.857422,23.045898h-8.945312l3.857422-23.045898H266.025391z M267.503906,0 l-1.134766,6.777344h-8.946289L258.556641,0H267.503906z"/>
  <path fill="#FFFFFF" d="M294.807617,0.72998l-5.198242,31.146973h-8.181641l0.564453-3.485352 c-1.884766,2.780273-4.164062,4.169922-6.838867,4.169922c-2.082031,0-3.875-0.821289-5.379883-2.464844 c-1.503906-1.642578-2.256836-3.993164-2.256836-7.049805c0-3.789062,1.041992-7.210449,3.125977-10.269043 c2.083008-3.056641,4.751953-4.585938,8.006836-4.585938c2.783203,0,4.660156,1.096191,5.633789,3.287598l1.787109-10.749512 H294.807617z M283.329102,17.021484c0.044922-0.243164,0.067383-0.50293,0.067383-0.776855 c0-0.65332-0.232422-1.20752-0.695312-1.663574c-0.461914-0.456543-1.019531-0.68457-1.672852-0.68457 c-1.5625,0-2.688477,1.205566-3.378906,3.616211c-0.69043,2.412109-1.035156,4.416016-1.035156,6.012695 c0,2.099609,0.814453,3.149414,2.444336,3.149414c1.614258,0,2.6875-1.048828,3.220703-3.147461L283.329102,17.021484z"/>
  <path fill="#FFFFFF" d="M320.798828,2.281738l-0.547852,5.75c-0.911133-0.105469-1.595703-0.15918-2.051758-0.15918 c-1.686523,0-2.834961,0.615723-3.442383,1.848633c2.356445,1.414062,3.53418,3.247559,3.53418,5.498535 c0,1.962891-0.766602,3.705078-2.299805,5.224609c-1.533203,1.521484-4.348633,2.282227-8.446289,2.282227 c-0.866211,0-1.579102-0.030273-2.140625-0.09082c-0.819336-0.091797-1.396484-0.136719-1.729492-0.136719 c-0.554688,0-1.010742,0.162109-1.37207,0.487305s-0.541016,0.699219-0.541016,1.121094 c0,0.363281,0.121094,0.65625,0.364258,0.882812s0.524414,0.359375,0.84375,0.395508 c0.319336,0.039062,1.686523,0.094727,4.104492,0.169922c2.644531,0.092773,4.357422,0.1875,5.140625,0.287109 c0.783203,0.098633,1.645508,0.400391,2.587891,0.902344c0.941406,0.50293,1.683594,1.208008,2.222656,2.114258 s0.80957,1.922852,0.80957,3.050781c0,2.163086-0.958008,4.052734-2.873047,5.667969 C313.046875,39.192383,309.421875,40,304.086914,40c-8.071289,0-12.106445-1.856445-12.106445-5.567383 c0-1.931641,1.37207-3.415039,4.117188-4.449219c-1.483398-0.989258-2.224609-2.213867-2.224609-3.673828 c0-2.555664,1.864258-4.373047,5.594727-5.453125c-2.134766-1.202148-3.201172-2.913086-3.201172-5.134766 c0-2.022949,0.880859-3.772461,2.644531-5.248047c1.763672-1.474609,4.727539-2.212891,8.891602-2.212891 c1.277344,0,2.470703,0.11377,3.580078,0.341797c0.65332-4.304688,3.009766-6.457031,7.068359-6.457031 C319.058594,2.145508,319.841797,2.19043,320.798828,2.281738z M300.527344,31.876953 c-0.865234,0.516602-1.296875,1.049805-1.296875,1.59668c0,1.15625,1.896484,1.734375,5.688477,1.734375 c1.865234,0,3.21875-0.118164,4.061523-0.353516c0.84082-0.235352,1.261719-0.696289,1.261719-1.380859 c0-0.456055-0.197266-0.756836-0.59082-0.901367c-0.395508-0.143555-1.251953-0.24707-2.571289-0.306641 C303.256836,32.09668,301.073242,31.967773,300.527344,31.876953z M307.154297,18.574219 c0.96875,0,1.729492-0.342773,2.282227-1.027344s0.828125-1.459961,0.828125-2.327148 c0-1.688477-0.832031-2.533203-2.49707-2.533203c-1.029297,0-1.813477,0.351074-2.350586,1.050781 s-0.805664,1.52832-0.805664,2.486328c0,0.745117,0.242188,1.323242,0.726562,1.734375S306.427734,18.574219,307.154297,18.574219z"/>
  <path fill="#FFFFFF" d="M345.650391,22.042969h-15.868164c-0.076172,0.625977-0.114258,1.092773-0.114258,1.397461 c0,1.008789,0.323242,1.796875,0.96875,2.362305c0.645508,0.566406,1.462891,0.848633,2.451172,0.848633 c1.869141,0,3.191406-0.972656,3.966797-2.920898l7.751953,1.255859c-1.00293,2.256836-2.625977,4.084961-4.868164,5.480469 c-2.241211,1.396484-4.730469,2.094727-7.466797,2.094727c-3.43457,0-6.220703-0.976562-8.355469-2.931641 c-2.135742-1.955078-3.204102-4.621094-3.204102-7.999023c0-3.665039,1.262695-6.810547,3.786133-9.434082 c2.522461-2.624512,5.821289-3.936035,9.894531-3.936035c3.450195,0,6.197266,1.01709,8.242188,3.052246 c2.043945,2.035156,3.06543,4.737793,3.06543,8.109863C345.900391,20.182617,345.816406,21.055664,345.650391,22.042969z M337.350586,17.615234c0.076172-0.470703,0.115234-0.835938,0.115234-1.094727c0-0.821777-0.255859-1.536133-0.763672-2.144531 c-0.510742-0.608398-1.220703-0.912598-2.132812-0.912598c-0.972656,0-1.853516,0.368164-2.644531,1.106445 s-1.276367,1.753418-1.458984,3.04541H337.350586z"/>
  <path fill-rule="evenodd" clip-rule="evenodd" fill="#4F8CCA" d="M34.401367,0.722168h22.350098c0,0,1.194336,0,1.15625,1.239258 L53.055664,30.75c-0.20752,1.061523-1.129395,1.125977-1.129395,1.125977h-22.41748c0,0-1.026367,0-0.961914-1.219727 l4.873047-28.866211C33.411133,0.790039,34.401367,0.722168,34.401367,0.722168z"/>
  <path fill-rule="evenodd" clip-rule="evenodd" fill="#6AA9DC" d="M62.686035,0.722168h22.350098c0,0,1.194336,0,1.15625,1.239258 L81.34082,30.75c-0.20752,1.061523-1.129883,1.125977-1.129883,1.125977H57.793945c0,0-1.026855,0-0.961914-1.219727 l4.873047-28.866211C61.696289,0.790039,62.686035,0.722168,62.686035,0.722168z"/>
  <path fill-rule="evenodd" clip-rule="evenodd" fill="#3B6BA0" d="M5.856934,0.722168h22.350098c0,0,1.194336,0,1.15625,1.239258 L24.511719,30.75c-0.20752,1.061523-1.129883,1.125977-1.129883,1.125977H0.964844c0,0-1.026855,0-0.961914-1.219727 L4.875977,1.790039C4.867188,0.790039,5.856934,0.722168,5.856934,0.722168z"/>
</svg></div>
        </div>
    </div>
    <!-- /.container -->
</nav>


  <!-- Page Content -->
  <div class="container-fluid">
    <div id="main">
      <!-- Content Row -->
      <div class="row">

        <div class="col-body">
          <!-- row-oriented flex container -->
          

          <!-- Sidebar Column -->
          <nav class="col-nav hidden-sm hidden-xs" id="tg-sb-sidebar">
            

<ul id="sidebar" class="sidebar">
  
  
  
  
  <li>
      <a href="#kubernetes-csi-storage-guide">ABOUT THIS GUIDE</a>
      <ul>
          
          
          
          <li><a href="#supported-versions">Supported Versions</a></li>
          
          
          
          
          
          
          <li><a href="#supported-features">Supported Features</a></li>
          
          
          
          
          
          
          <li><a href="#supported-k8s-environments">Supported k8s Environments</a></li>
          
          
          
          
          
          
          <li><a href="#requirements">Requirements</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#quickstart">QUICKSTART</a>
      <ul>
          
          
          
          <li><a href="#blockbridge-configuration">Blockbridge Configuration</a></li>
          
          
          
          
          
          
          <li><a href="#kubernetes-configuration">Kubernetes Configuration</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#configuration--deployment">CONFIGURATION & DEPLOYMENT</a>
      <ul>
          
          
          
          <li><a href="#linked-blockbridge-account">Linked Blockbridge Account</a></li>
          
          
          
          
          
          
          <li><a href="#authorization-token">Authorization Token</a></li>
          
          
          
          
          
          
          <li><a href="#driver-installation">Driver Installation</a></li>
          
          
          
          
          
          
          <li><a href="#storage-classes">Storage Classes</a></li>
          
          
          
          
          
          
          <li><a href="#testing">Testing</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#troubleshooting">TROUBLESHOOTING</a>
      <ul>
          
          
          
          <li><a href="#app-stuck-in-containercreating">App Stuck in ContainerCreating</a></li>
          
          
          
          
          
          
          <li><a href="#provisioning-unauthorized">Provisioning Unauthorized</a></li>
          
          
          
          
          
          
          <li><a href="#provisioning-storage-class-invalid">Provisioning Storage Class Invalid</a></li>
          
          
          
          
          
          
          <li><a href="#app-stuck-in-pending">App Stuck in Pending</a></li>
          
          
          
          
      </ul>
   </li>
     
      
      
      <!-- if you aren't using the accordion, uncomment this block:
         <p class="external">
             <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
         </p>
         -->
</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

          </nav>
          

          <!-- Content Column -->
          <main class="col-content">
            <div class="post-header">
   <h1 class="post-title-main">KUBERNETES CSI STORAGE GUIDE</h1>
</div>



<div class="post-content">

   

    


    

   <p>Blockbridge provides a Container Storage Interface
(<a href="https://github.com/container-storage-interface/spec">CSI</a>) driver to deliver
persistent, secure, multi-tenant, cluster-accessible storage for
<a href="https://kubernetes-csi.github.io/docs/">Kubernetes</a>.  This guide describes how
to deploy Blockbridge as the storage backend for Kubernetes containers.</p>

<p>If you’ve configured other Kubernetes storage drivers before, you may want to
start with the <strong><a href="#quickstart">Quickstart</a></strong> section. The rest of the guide has
detailed information about features, driver configuration options and
troubleshooting.</p>

<hr />

<h1 id="requirements--versions">REQUIREMENTS &amp; VERSIONS</h1>

<h2 id="supported-versions">Supported Versions</h2>

<p>Blockbridge supports Kubernetes version 1.14+.</p>

<table>
  <thead>
    <tr>
      <th>Component</th>
      <th>Version</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Blockbridge</td>
      <td>5.1</td>
    </tr>
    <tr>
      <td>Blockbridge K8s Driver</td>
      <td>2.0.0</td>
    </tr>
    <tr>
      <td>Kubernetes</td>
      <td>1.14+</td>
    </tr>
    <tr>
      <td>CSI (container storage) Specification</td>
      <td>1.0.0</td>
    </tr>
  </tbody>
</table>

<h2 id="supported-features">Supported Features</h2>

<ul>
  <li>Dynamic volume provisioning</li>
  <li>Automatic volume failover and mobility across the cluster</li>
  <li>Integration with RBAC for multi-namespace, multi-tenant deployments</li>
  <li>Quality of Service</li>
  <li>Encryption in-flight for control (always) and data (optional)</li>
  <li>Encryption at rest</li>
  <li>Multiple Storage Classes provide programmable, deterministic storage characteristics</li>
</ul>

<h2 id="supported-k8s-environments">Supported K8s Environments</h2>

<ul>
  <li>Rancher 2.4+</li>
  <li>Mirantis Kubernetes Engine 3.1+ (formerly Docker EE)</li>
</ul>

<h2 id="requirements">Requirements</h2>

<p>The following minimum requirements must be met to use the Blockbridge driver in Kubernetes:</p>

<ul>
  <li>Kubernetes 1.14+.</li>
  <li><code class="highlighter-rouge">--allow-privileged</code> flag must be set to true for the Kubernetes API server.</li>
  <li><a href="https://kubernetes.io/docs/concepts/storage/volumes/#mount-propagation">MountPropagation must be
enabled</a>
(default to true since version 1.10).</li>
  <li>If you use Docker, the Docker daemon of the cluster nodes <a href="https://kubernetes.io/docs/concepts/storage/volumes/#configuration">must allow shared
mounts</a>.</li>
</ul>

<p>See <a href="https://kubernetes-csi.github.io/docs/deploying.html">CSI Deploying</a> for
more information.</p>

<hr />

<h1 id="quickstart">QUICKSTART</h1>

<p>This is a brief guide on how to install and configure the Blockbridge
Kubernetes driver.  In this section, you will:</p>

<ol>
  <li>Create a Blockbridge account for your Kubernetes storage.</li>
  <li>Create an authentication token for the Kubernetes driver.</li>
  <li>Define a secret in Kubernetes with the token and the Blockbridge API host.</li>
  <li>Deploy the Kubernetes driver.</li>
</ol>

<p>Many of these topics have more information available by selecting the
information <strong>ⓘ</strong> links next to items where they appear.</p>

<h2 id="blockbridge-configuration">Blockbridge Configuration</h2>

<p>These steps use the containerized Blockbridge CLI utility to create an account
and an authorization token.</p>

<ol>
  <li>
    <p><strong>Set <code class="highlighter-rouge">BLOCKBRIDGE_API_HOST</code> to point to your Blockbridge API endpoint.</strong></p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ export BLOCKBRIDGE_API_HOST=blockbridge.mycompany.example
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>Use the containerized CLI to create the account.</strong></p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ docker run --rm -it -e BLOCKBRIDGE_API_HOST docker.io/blockbridge/cli:latest-alpine bb --no-ssl-verify-peer account create --name kubernetes
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>When prompted, authenticate as the <code class="highlighter-rouge">system</code> user.</strong></p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Authenticating to https://blockbridge.mycompany.example/api

 Enter user or access token: system
 Password for system: ....
 Authenticated; token expires in 3599 seconds.
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>Use the containerized CLI to create the auth token.</strong></p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ export BLOCKBRIDGE_API_HOST=blockbridge.mycompany.example
 $ export BLOCKBRIDGE_API_SU=kubernetes
 $ docker run --rm -it -e BLOCKBRIDGE_API_HOST -e BLOCKBRIDGE_API_SU docker.io/blockbridge/cli:latest-alpine bb --no-ssl-verify-peer authorization create --notes 'csi-blockbridge driver access'
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>Again, authenticate as the <code class="highlighter-rouge">system</code> user.</strong></p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Authenticating to https://blockbridge.mycompany.example/api

 Enter user or access token: system
 Password for system:
 Authenticated; token expires in 3599 seconds.
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>Set the <code class="highlighter-rouge">BLOCKBRIDGE_API_KEY</code> environment variable to the new token.</strong></p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ export BLOCKBRIDGE_API_KEY="1/Nr7qLedL/P0KXxbrB8+jpfrFPBrNi3X+8H9BBwyOYg/mvOot50v2vA"
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="kubernetes-configuration">Kubernetes Configuration</h2>

<p>The following steps install and configure the Blockbridge Kubernetes driver on
your cluster.  Your session must already be authenticated with your Kubernetes
cluster to proceed.</p>

<ol>
  <li>
    <p><strong>Create a file with the definition of a <em>secret</em> for the Blockbridge API.</strong></p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ cat &gt; secret.yml &lt;&lt;- EOF
 apiVersion: v1
 kind: Secret
 metadata:
   name: blockbridge
   namespace: kube-system
 stringData:
   api-url: "https://${BLOCKBRIDGE_API_HOST}/api"
   access-token: "$BLOCKBRIDGE_API_KEY"
   ssl-verify-peer: "false"
 EOF
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>Create the secret in Kubernetes.</strong></p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ kubectl create -f ./secret.yml
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>Check that the secret exists.</strong></p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ kubectl -n kube-system get secrets blockbridge
 NAME          TYPE      DATA      AGE
 blockbridge   Opaque    3         2m
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>Deploy the Blockbridge driver.</strong></p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ kubectl apply -f https://get.blockbridge.com/kubernetes/5.1/csi/csi-blockbridge-v2.0.0.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>Check that the driver is running.</strong></p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ kubectl -n kube-system get pods -l role=csi-blockbridge
 NAME                                    READY     STATUS    RESTARTS   AGE
 csi-blockbridge-controller-0            3/3       Running   0          6s
 csi-blockbridge-node-4679b              2/2       Running   0          5s
</code></pre></div>    </div>
  </li>
</ol>

<hr />

<h1 id="configuration--deployment">CONFIGURATION &amp; DEPLOYMENT</h1>

<p>This section discusses how to configure the Blockbridge Kubernetes driver in
detail.</p>

<h2 id="linked-blockbridge-account">Linked Blockbridge Account</h2>

<p>The Blockbridge driver creates and maintains its storage under a tenant account
on your Blockbridge installation.</p>

<p>The driver is configured with two pieces of information: the API endpoint and
the authentication token.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">configuration</th>
      <th style="text-align: left">description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">BLOCKBRIDGE_API_URL</td>
      <td style="text-align: left">Blockbridge controlplane API endpoint URL specified as <code class="highlighter-rouge">https://hostname.example/api</code></td>
    </tr>
    <tr>
      <td style="text-align: left">BLOCKBRIDGE_API_KEY</td>
      <td style="text-align: left">Blockbridge controlplane access token</td>
    </tr>
  </tbody>
</table>

<p>The API endpoint is specified as a URL pointing to the Blockbridge
controlplane’s API. The access token authenticates the driver with the
Blockbridge controlplane, in the context of the specified account.</p>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> This guide assumes that the Blockbridge
controlplane is running and a system password has been set. For help setting up
the Blockbridge controlplane, please contact <a href="mailto:support@blockbridge.com">Blockbridge
Support</a>.</div>

<h3 id="account-creation">Account Creation</h3>

<p>Use the containerized Blockbridge CLI to create the account.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ export BLOCKBRIDGE_API_HOST=blockbridge.mycompany.example
    $ docker run --rm -it -e BLOCKBRIDGE_API_HOST docker.io/blockbridge/cli:latest-alpine bb --no-ssl-verify-peer account create --name kubernetes
</code></pre></div></div>

<p>When prompted, authenticate to the Blockbridge controlplane as the <code class="highlighter-rouge">system</code> user.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    Authenticating to https://blockbridge.mycompany.example/api

    Enter user or access token: system
    Password for system: ....
    Authenticated; token expires in 3599 seconds.

</code></pre></div></div>

<p>Validate that the account has been created.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    == Created account: kubernetes (ACT0762194C40656F03)

    == Account: kubernetes (ACT0762194C40656F03)
    name                  kubernetes
    label                 kubernetes
    serial                ACT0762194C40656F03
    created               2018-11-19 16:15:15 +0000
    disabled              no
</code></pre></div></div>

<h2 id="authorization-token">Authorization Token</h2>

<p>Blockbridge supports revokable persistent authorization tokens.  This section
demonstrates how to create a persistent authorization token in the freshly
created <code class="highlighter-rouge">kubernetes</code> account suitable for use as authentication for the driver.</p>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> Although Blockbridge supports password-based
authentication, tokens are far simpler to use in this context.  It’s easier to
revoke a token than change a password.</div>

<p>To create the token, first authenticate as the <code class="highlighter-rouge">system</code> user.  Then use the
containerized Blockbridge CLI tool with the <code class="highlighter-rouge">BLOCKBRIDGE_API_SU</code> environment
variable to create a persistent authorization in the <code class="highlighter-rouge">kubernetes</code> account.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ export BLOCKBRIDGE_API_HOST=blockbridge.mycompany.example
    $ export BLOCKBRIDGE_API_SU=kubernetes
    $ docker run --rm -it -e BLOCKBRIDGE_API_HOST -e BLOCKBRIDGE_API_SU docker.io/blockbridge/cli:latest-alpine bb --no-ssl-verify-peer authorization create --notes 'csi-blockbridge driver access'
</code></pre></div></div>

<p>Once again, authenticate using the <code class="highlighter-rouge">system</code> username and password.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    Authenticating to https://blockbridge.mycompany.example/api

    Enter user or access token: system
    Password for system: 
    Authenticated; token expires in 3599 seconds.
</code></pre></div></div>

<p>This creates the authorization and displays the access token.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    == Created authorization: ATH4762194C4062668E

    == Authorization: ATH4762194C4062668E
    serial                ATH4762194C4062668E
    account               kubernetes (ACT0762194C40656F03)
    user                  kubernetes (USR1B62194C40656FBD)
    enabled               yes
    created at            2018-11-19 11:15:47 -0500
    access type           online
    token suffix          ot50v2vA
    restrict              auth
    enforce 2-factor      false

    == Access Token
    access token          1/Nr7qLedL/P0KXxbrB8+jpfrFPBrNi3X+8H9BBwyOYg/mvOot50v2vA

    *** Remember to record your access token!
</code></pre></div></div>

<p>Make a note of the displayed access token somewhere safe. Set the environment
variable <code class="highlighter-rouge">BLOCKBRIDGE_API_KEY</code> to use in the forthcoming steps to install
the driver.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ export BLOCKBRIDGE_API_KEY="1/Nr7qLedL/P0KXxbrB8+jpfrFPBrNi3X+8H9BBwyOYg/mvOot50v2vA"
</code></pre></div></div>

<h2 id="driver-installation">Driver Installation</h2>

<p>Here’s how to install the Blockbridge driver in your Kubernetes cluster.</p>

<h3 id="authenticate-with-kubernetes">Authenticate with Kubernetes</h3>

<p>First, ensure your session is authenticated to your Kubernetes cluster. Running
<code class="highlighter-rouge">kubectl version</code> should show a version for both the client and server
successfully.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kubectl version
Client Version: version.Info{Major:"1", Minor:"19", GitVersion:"v1.19.7", GitCommit:"1dd5338295409edcfff11505e7bb246f0d325d15", GitTreeState:"clean", BuildDate:"2021-01-13T13:23:52Z", GoVersion:"go1.15.5", Compiler:"gc", Platform:"darwin/amd64"}
Server Version: version.Info{Major:"1", Minor:"20", GitVersion:"v1.20.4", GitCommit:"e87da0bd6e03ec3fea7933c4b5263d151aafd07c", GitTreeState:"clean", BuildDate:"2021-02-18T16:03:00Z", GoVersion:"go1.15.8", Compiler:"gc", Platform:"linux/amd64"}
</code></pre></div></div>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> Setting up <code class="highlighter-rouge">kubectl</code> authentication is beyond the
scope of this guide.  Please refer to the specific instructions for the
Kubernetes service or installation you are using.</div>

<h3 id="create-a-secret">Create a Secret</h3>

<p>Next, create a secret containing both the Blockbridge API endpoint URL and access
token.</p>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> While control traffic is always encrypted, we
specify here to disable peer certificate verification using the
<code class="highlighter-rouge">ssl-verify-peer</code> flag. This setting implicitly trusts the default controlplane
self-signed certificate. Configuring certificate verification, including
specifying custom-supplied CA certificates, is beyond the scope of this
guide. Please contact <a href="mailto:support@blockbridge.com">Blockbridge Support</a> for
more information.</div>

<p>Use <code class="highlighter-rouge">BLOCKBRIDGE_API_HOST</code> and <code class="highlighter-rouge">BLOCKBRIDGE_API_KEY</code> with the correct values
for the Blockbridge controlplane, and the access token you created earlier in
the <strong>kubernetes</strong> account.  Here’s how to do it with a “here” document that
expands the variables:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ cat &gt; secret.yml &lt;&lt;- EOF
    apiVersion: v1
    kind: Secret
    metadata:
      name: blockbridge
      namespace: kube-system
    stringData:
      api-url: "https://${BLOCKBRIDGE_API_HOST}/api"
      access-token: "$BLOCKBRIDGE_API_KEY"
      ssl-verify-peer: "false"
    EOF
</code></pre></div></div>

<p>Verify that its contents are correct.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ cat secret.yml
    apiVersion: v1
    kind: Secret
    metadata:
      name: blockbridge
      namespace: kube-system
    stringData:
      api-url: "https://blockbridge.mycompany.example/api"
      access-token: "1/Nr7qLedL/P0KXxbrB8+jpfrFPBrNi3X+8H9BBwyOYg/mvOot50v2vA"
      ssl-verify-peer: "false"
</code></pre></div></div>

<p>Next, use <code class="highlighter-rouge">secret.yml</code> to create the secret in Kubernetes.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl create -f ./secret.yml
    secret "blockbridge" created
</code></pre></div></div>

<p>Finally, ensure the secret exists in the <code class="highlighter-rouge">kube-system</code> namespace.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl -n kube-system get secrets blockbridge
    NAME          TYPE      DATA      AGE
    blockbridge   Opaque    3         2m
</code></pre></div></div>

<h3 id="deploy-the-blockbridge-driver">Deploy the Blockbridge Driver</h3>

<p>Deploy the Blockbridge Driver as a DaemonSet / StatefulSet using <code class="highlighter-rouge">kubectl</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl apply -f https://get.blockbridge.com/kubernetes/5.1/csi/csi-blockbridge-v2.0.0.yaml
</code></pre></div></div>

<p>If everything was created successfully, the command output should look like
this, with all lines ending in <code class="highlighter-rouge">created</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    csidriver.storage.k8s.io/csi.blockbridge.com created
    storageclass.storage.k8s.io/blockbridge-gp created
    storageclass.storage.k8s.io/blockbridge-tls created
    statefulset.apps/csi-blockbridge-controller created
    serviceaccount/csi-blockbridge-controller-sa created
    clusterrole.rbac.authorization.k8s.io/csi-blockbridge-provisioner-role created
    clusterrolebinding.rbac.authorization.k8s.io/csi-blockbridge-provisioner-binding created
    clusterrole.rbac.authorization.k8s.io/csi-blockbridge-attacher-role created
    clusterrolebinding.rbac.authorization.k8s.io/csi-blockbridge-attacher-binding created
    daemonset.apps/csi-blockbridge-node created
    serviceaccount/csi-blockbridge-node-sa created
    clusterrole.rbac.authorization.k8s.io/csi-blockbridge-node-driver-registrar-role created
    clusterrolebinding.rbac.authorization.k8s.io/csi-blockbridge-node-driver-registrar-binding created
</code></pre></div></div>

<p>For reference, the Blockbridge CSI Driver is deployed using the <a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/storage/container-storage-interface.md#recommended-mechanism-for-deploying-csi-drivers-on-kubernetes">recommended
mechanism</a> of deploying CSI drivers on Kubernetes.</p>

<h3 id="ensure-the-driver-is-operational">Ensure the Driver is Operational</h3>

<p>Finally, check that the driver is up and running.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl -n kube-system get pods -l role=csi-blockbridge
    NAME                                    READY     STATUS    RESTARTS   AGE
    csi-blockbridge-controller-0            3/3       Running   0          6s
    csi-blockbridge-node-4679b              2/2       Running   0          5s
</code></pre></div></div>

<h2 id="storage-classes">Storage Classes</h2>

<p>The Blockbridge driver comes with a default “general purpose” StorageClass
named <code class="highlighter-rouge">blockbridge-gp</code>.  This is the <strong>default</strong> StorageClass for dynamic
provisioning of storage volumes. It provisions using the default Blockbridge
storage template configured in the Blockbridge controlplane.</p>

<p>There are a variety of additional storage class configuration options available,
including:</p>

<ol>
  <li>Using transport encryption (tls).</li>
  <li>Using a custom tag-based query.</li>
  <li>Using a named service template.</li>
  <li>Using explicitly specified provisioned IOPS.</li>
</ol>

<p>There are several additional example storage classes in
<code class="highlighter-rouge">csi-storageclass.yaml</code>. You can download, edit, and apply these storage
classes as needed.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ curl -OsSL https://get.blockbridge.com/kubernetes/5.1/csi/csi-storageclass.yaml
    $ cat csi-storageclass.yaml
    ... [output trimmed] ...
    ---
    kind: StorageClass
    apiVersion: storage.k8s.io/v1
    metadata:
      name: blockbridge-gp
      namespace: kube-system
      annotations:
        storageclass.kubernetes.io/is-default-class: "true"
    provisioner: csi.blockbridge.com
    allowVolumeExpansion: true
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl apply -f ./csi-storageclass.yaml
    storageclass.storage.k8s.io "blockbridge-gp" configured
</code></pre></div></div>

<h2 id="testing">Testing</h2>

<p>This section has a few basic tests you can use to validate that your
Blockbridge driver is working properly.</p>

<h3 id="create-a-volume">Create a Volume</h3>

<p>This verifies that Blockbridge storage volumes are now available via Kubernetes
persistent volume claims (PVC).</p>

<p>To test this out, create a PersistentVolumeClaim. It will dynamically provision a
volume in Blockbridge and make it accessible to applications.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl apply -f https://get.blockbridge.com/kubernetes/5.1/examples/csi-pvc.yaml
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    persistentvolumeclaim "csi-pvc-blockbridge" created
</code></pre></div></div>

<p>Alternatively, download the example volume yaml, modify it as needed, and apply.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ curl -OsSL https://get.blockbridge.com/kubernetes/5.1/examples/csi-pvc.yaml
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ cat csi-pvc.yaml
    ---
    apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: csi-pvc-blockbridge-example
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 5Gi
      storageClassName: blockbridge-gp
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl apply -f ./csi-pvc.yaml
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    persistentvolumeclaim "csi-pvc-blockbridge" created
</code></pre></div></div>

<p>Use <code class="highlighter-rouge">get pvc csi-pvc-blockbridge</code> to check that the PVC was created
successfully.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl get pvc csi-pvc-blockbridge
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    NAME                  STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS     AGE
    csi-pvc-blockbridge   Bound    pvc-6cb93ab2-ec49-11e8-8b89-46facf8570bb   5Gi        RWO            blockbridge-gp   4s
</code></pre></div></div>

<h3 id="create-a-pod">Create a Pod</h3>

<p>This test creates a Pod (application) that uses the PVC just created.  When you
create the Pod, it attaches the volume, then formats and mounts it, making it
available to the specified application.</p>

<p>Create the application.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl apply -f https://get.blockbridge.com/kubernetes/5.1/examples/csi-app.yaml
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    pod "blockbridge-demo" created
</code></pre></div></div>

<p>Alternatively, download the application yaml, modify as needed, and apply.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ curl -OsSL https://get.blockbridge.com/kubernetes/5.1/examples/csi-app.yaml
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ cat csi-app.yaml
    ---
    kind: Pod
    apiVersion: v1
    metadata:
      name: blockbridge-demo
    spec:
      containers:
        - name: my-frontend
          image: busybox
          volumeMounts:
          - mountPath: "/data"
            name: my-bb-volume
          command: [ "sleep", "1000000" ]
        - name: my-backend
          image: busybox
          volumeMounts:
          - mountPath: "/data"
            name: my-bb-volume
          command: [ "sleep", "1000000" ]
      volumes:
        - name: my-bb-volume
          persistentVolumeClaim:
            claimName: csi-pvc-blockbridge
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl apply -f ./csi-app.yaml
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    pod "blockbridge-demo" created
</code></pre></div></div>

<p>Verify that the pod is running successfully.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl get pod blockbridge-demo
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    NAME               READY     STATUS    RESTARTS   AGE
    blockbridge-demo   2/2       Running   0          13s
</code></pre></div></div>

<h3 id="write-data-from-the-pod">Write Data From the Pod</h3>

<p>Inside the app container, write data to the mounted volume.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl exec -ti blockbridge-demo -c my-frontend /bin/sh
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    / # df /data
    Filesystem           1K-blocks      Used Available Use% Mounted on
    /dev/blockbridge/2f93beb2-61eb-456b-809e-22e27e4f73cf
                           5232608     33184   5199424   1% /data

    / # touch /data/hello-world
    / # exit
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl exec -ti blockbridge-demo -c my-backend /bin/sh
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    / # ls /data
    hello-world
</code></pre></div></div>

<hr />

<h1 id="troubleshooting">TROUBLESHOOTING</h1>

<h2 id="app-stuck-in-containercreating">App Stuck in ContainerCreating</h2>

<p>When the application is stuck in ContainerCreating, check to see if the mount
has failed.</p>

<h3 id="symptom">Symptom</h3>

<p>Check the app status.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kubectl get pod/blockbridge-demo
NAME               READY   STATUS              RESTARTS   AGE
blockbridge-demo   0/2     ContainerCreating   0          20s

$ kubectl describe pod/blockbridge-dmo
Events:
  Type     Reason                  Age   From                            Message
  ----     ------                  ----  ----                            -------
  Normal   Scheduled               10s   default-scheduler               Successfully assigned default/blockbridge-demo to kubelet.localnet
  Normal   SuccessfulAttachVolume  10s   attachdetach-controller         AttachVolume.Attach succeeded for volume "pvc-71c37e84-b302-11e9-a93f-0242ac110003"
  Warning  FailedMount             1s    kubelet, kubelet.localnet       MountVolume.MountDevice failed for volume "pvc-71c37e84-b302-11e9-a93f-0242ac110003" : rpc error: code = Unknown desc = runtime_error: /etc/iscsi/initiatorname.iscsi not found; ensure 'iscsi-initiator-utils' is installed.
</code></pre></div></div>

<h3 id="resolution">Resolution</h3>

<ul>
  <li>Ensure the host running the kubelet has iSCSI client support installed on the host/node.</li>
  <li>For CentOS/RHEL, install the <code class="highlighter-rouge">iscsi-initiator-utils</code> package on the host running the kubelet.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    yum install iscsi-initiator-utils
</code></pre></div></div>

<ul>
  <li>For Ubuntu, install the <code class="highlighter-rouge">open-iscsi-utils</code> package on the host running the kubelet.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    apt install open-iscsi-utils
</code></pre></div></div>

<ul>
  <li>Delete/re-create the application pod to retry.</li>
</ul>

<h2 id="provisioning-unauthorized">Provisioning Unauthorized</h2>

<p>In this failure mode, provisioning fails with an “unauthorized” message.</p>

<h3 id="symptom-1">Symptom</h3>

<p>Check the PVC describe output.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl describe pvc csi-pvc-blockbridge
</code></pre></div></div>

<p>Provisioning failed due to “unauthorized” because the authorization access token is not valid. Ensure the correct access token is entered in the secret.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      Warning  ProvisioningFailed    6s (x2 over 19s)  csi.blockbridge.com csi-provisioner-blockbridge-0 2caddb79-ec46-11e8-845d-465903922841  Failed to provision volume with StorageClass "blockbridge-gp": rpc error: code = Internal desc = unauthorized_error: unauthorized: unauthorized
</code></pre></div></div>

<h3 id="resolution-1">Resolution</h3>

<ul>
  <li>Edit <code class="highlighter-rouge">secret.yml</code> and ensure correct access token and API URL are set.</li>
  <li>delete secret: <code class="highlighter-rouge">kubectl delete -f secret.yml</code></li>
  <li>create secret: <code class="highlighter-rouge">kubectl create -f secret.yml</code></li>
  <li>remove old configuration:
    <ul>
      <li><code class="highlighter-rouge">kubectl delete -f https://get.blockbridge.com/kubernetes/5.1/examples/csi-pvc.yaml</code></li>
      <li><code class="highlighter-rouge">kubectl delete -f https://get.blockbridge.com/kubernetes/5.1/csi/csi-blockbridge-v2.0.0.yaml</code></li>
    </ul>
  </li>
  <li>re-apply configuration:
    <ul>
      <li><code class="highlighter-rouge">kubectl apply -f https://get.blockbridge.com/kubernetes/5.1/csi/csi-blockbridge-v2.0.0.yaml</code></li>
      <li><code class="highlighter-rouge">kubectl delete -f https://get.blockbridge.com/kubernetes/5.1/examples/csi-pvc.yaml</code></li>
    </ul>
  </li>
</ul>

<h2 id="provisioning-storage-class-invalid">Provisioning Storage Class Invalid</h2>

<p>Provisioning fails with an “invalid storage class” error.</p>

<h3 id="symptom-2">Symptom</h3>
<p>Check the PVC describe output:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl describe pvc csi-pvc-blockbridge
</code></pre></div></div>

<p>Provisioning failed because the storage class specified was invalid.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      Warning  ProvisioningFailed  7s (x3 over 10s)  persistentvolume-controller  storageclass.storage.k8s.io "blockbridge-gp" not found
</code></pre></div></div>

<h3 id="resolution-2">Resolution</h3>

<p>Ensure the StorageClass exists with the same name.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl get storageclass blockbridge-gp
    Error from server (NotFound): storageclasses.storage.k8s.io "blockbridge-gp" not found
</code></pre></div></div>

<ul>
  <li>If it doesn’t exist, then create the storageclass.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl apply -f https://get.blockbridge.com/kubernetes/5.1/csi/csi-storageclass.yaml
</code></pre></div></div>

<ul>
  <li>Alternatively, download and edit the desired storageclass.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ curl -OsSL https://get.blockbridge.com/kubernetes/5.1/csi/csi-storageclass.yaml
    $ edit csi-storageclass.yaml
    $ kubectl -f apply ./csi-storageclass.yaml
</code></pre></div></div>

<p>In the background, the PVC continually retries.  Once the above changes are
complete, it will pick up the storage class change.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl get pvc
    NAME                    STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      AGE
    csi-pvc-blockbridge     Bound     pvc-6cb93ab2-ec49-11e8-8b89-46facf8570bb   5Gi        RWO            blockbridge-gp     4s
</code></pre></div></div>

<h2 id="app-stuck-in-pending">App Stuck in Pending</h2>

<p>One of the causes for an application stuck in pending is a missing Persistent
Volume Claim (PVC).</p>

<h3 id="symptom-3">Symptom</h3>

<p>The output of <code class="highlighter-rouge">get pod</code> show that the app is stuck in pending.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl get pod blockbridge-demo
    NAME               READY     STATUS    RESTARTS   AGE
    blockbridge-demo   0/2       Pending   0          14s
</code></pre></div></div>

<p>Use <code class="highlighter-rouge">describe pod</code> to reveal more information.  In this case, the PVC is not
found.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl describe pod blockbridge-demo

    Events:
      Type     Reason            Age                From               Message
      ----     ------            ----               ----               -------
      Warning  FailedScheduling  12s (x6 over 28s)  default-scheduler  persistentvolumeclaim "csi-pvc-blockbridge" not found
</code></pre></div></div>

<h3 id="resolution-3">Resolution</h3>

<p>Create the PVC if necessary and ensure that it’s valid.  First, validate that
it’s missing.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl get pvc csi-pvc-blockbridge
    Error from server (NotFound): persistentvolumeclaims "csi-pvc-blockbridge" not found
</code></pre></div></div>

<p>If it’s missing, create it.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl apply -f https://get.blockbridge.com/kubernetes/5.1/examples/csi-pvc.yaml
persistentvolumeclaim "csi-pvc-blockbridge" created
</code></pre></div></div>

<p>In the background, the application retries automatically and succeeds in
starting.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ kubectl describe pod blockbridge-demo
      Normal   Scheduled               8s  default-scheduler                  Successfully assigned blockbridge-demo to aks-nodepool1-56242131-0
      Normal   SuccessfulAttachVolume  8s  attachdetach-controller            AttachVolume.Attach succeeded for volume "pvc-5332e169-ec4f-11e8-8b89-46facf8570bb"
      Normal   SuccessfulMountVolume   8s  kubelet, aks-nodepool1-56242131-0  MountVolume.SetUp succeeded for volume "default-token-bx8b9"
</code></pre></div></div>


    <div class="tags">
        
    </div>

</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               &copy;2021 Blockbridge Networks LLC. All rights reserved. <br />
 Site last generated: Apr 5, 2021
                </div>
            </div>
</footer>


          </main>

          <!-- /.col-body -->
        </div>

        <!-- /.row -->
      </div>
      <!-- /#main -->
    </div>
  </div>

</body>

</html>
